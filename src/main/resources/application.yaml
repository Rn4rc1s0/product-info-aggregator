spring:
  application:
    name: product-info-aggregator
  threads:
    virtual:
      enabled: true

springdoc:
  swagger-ui:
    path: /swagger-ui

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,circuitbreakers,retries,circuitbreakerevents,retryevents
  endpoint:
    health:
      probes:
        enabled: true
      show-details: when_authorized
  metrics:
    tags:
      application: ${spring.application.name}
    distribution:
      percentiles-histogram:
        http.server.requests: true

# ============================================
# Resilience4j Configuration
# ============================================
# Only configuring what we actually use:
# - TimeLimiter: timeout for upstream calls
# - CircuitBreaker: prevent cascade failures
# - Retry: handle transient failures
# ============================================

resilience4j:
  timelimiter:
    instances:
      pricing:
        timeout-duration: 500ms      # 80ms base + retries + margin
        cancel-running-future: true
      availability:
        timeout-duration: 600ms      # 100ms base + retries + margin
        cancel-running-future: true
      customer:
        timeout-duration: 400ms      # 60ms base + retries + margin
        cancel-running-future: true
      catalog:
        timeout-duration: 800ms      # 50ms base + retries + margin (critical service)
        cancel-running-future: true

  circuitbreaker:
    configs:
      default:
        register-health-indicator: true
        event-consumer-buffer-size: 50
    instances:
      pricing:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 80
        slow-call-duration-threshold: 200ms
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 5
        automatic-transition-from-open-to-half-open-enabled: true
        record-exceptions:
          - java.util.concurrent.TimeoutException
          - com.kramp.productinfo.domain.ports.exception.UpstreamFailureException
          - java.io.IOException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
      availability:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 80
        slow-call-duration-threshold: 250ms
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 5
        automatic-transition-from-open-to-half-open-enabled: true
        record-exceptions:
          - java.util.concurrent.TimeoutException
          - com.kramp.productinfo.domain.ports.exception.UpstreamFailureException
          - java.io.IOException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
      customer:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 80
        slow-call-duration-threshold: 150ms
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 5
        automatic-transition-from-open-to-half-open-enabled: true
        record-exceptions:
          - java.util.concurrent.TimeoutException
          - com.kramp.productinfo.domain.ports.exception.UpstreamFailureException
          - java.io.IOException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
      catalog:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 80
        slow-call-duration-threshold: 150ms
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        wait-duration-in-open-state: 5s   # Shorter for critical service
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
        record-exceptions:
          - java.util.concurrent.TimeoutException
          - com.kramp.productinfo.domain.ports.exception.UpstreamFailureException
          - java.io.IOException
        ignore-exceptions:
          - java.lang.IllegalArgumentException

  retry:
    configs:
      default:
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
    instances:
      pricing:
        max-attempts: 3
        wait-duration: 100ms
        retry-exceptions:
          - java.util.concurrent.TimeoutException
          - com.kramp.productinfo.domain.ports.exception.UpstreamFailureException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
      availability:
        max-attempts: 3
        wait-duration: 100ms
        retry-exceptions:
          - java.util.concurrent.TimeoutException
          - com.kramp.productinfo.domain.ports.exception.UpstreamFailureException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
      customer:
        max-attempts: 2
        wait-duration: 50ms
        retry-exceptions:
          - java.util.concurrent.TimeoutException
          - com.kramp.productinfo.domain.ports.exception.UpstreamFailureException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
      catalog:
        max-attempts: 3
        wait-duration: 150ms
        retry-exceptions:
          - java.util.concurrent.TimeoutException
          - com.kramp.productinfo.domain.ports.exception.UpstreamFailureException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
